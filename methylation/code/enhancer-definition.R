define_chip_vtracks <- function() {    
    gvtrack.create("e10_limb_k4me1", "ENCODE.bing_ren.e10_5.limb.h3k4me1_sum", "global.percentile")
    gvtrack.create("e10_heart_k4me1", "ENCODE.bing_ren.e10_5.heart.h3k4me1_sum", "global.percentile")
    gvtrack.create("e10_fc_k4me1", "ENCODE.bing_ren.e10_5.embryonic_facial_prominence.h3k4me1_sum", "global.percentile")
    gvtrack.create("e10_midbrain_k4me1", "ENCODE.bing_ren.e10_5.midbrain.h3k4me1_sum", "global.percentile")
    gvtrack.create("e10_hindbrain_k4me1", "ENCODE.bing_ren.e10_5.hindbrain.h3k4me1_sum", "global.percentile")
    gvtrack.create("e10_forebrain_k4me1", "ENCODE.bing_ren.e10_5.forebrain.h3k4me1_sum", "global.percentile")
    gvtrack.create("e11_liver_k4me1", "ENCODE.bing_ren.e11_5.liver.h3k4me1_sum", "global.percentile")
    gvtrack.create("e14_stomach_k4me1", "ENCODE.bing_ren.e14_5.stomach.h3k4me1_sum", "global.percentile")
    gvtrack.create("e14_kidney_k4me1", "ENCODE.bing_ren.e14_5.kidney.h3k4me1_sum", "global.percentile")

    gvtrack.create("e10_limb_k27ac", "ENCODE.bing_ren.e10_5.limb.h3k27ac_dense", "global.percentile")
    gvtrack.create("e10_heart_k27ac", "ENCODE.bing_ren.e10_5.heart.h3k27ac_dense", "global.percentile")    
    gvtrack.create("e10_midbrain_k27ac", "ENCODE.bing_ren.e10_5.midbrain.h3k27ac_dense", "global.percentile")
    gvtrack.create("e10_hindbrain_k27ac", "ENCODE.bing_ren.e10_5.hindbrain.h3k27ac_dense", "global.percentile")
    gvtrack.create("e10_forebrain_k27ac", "ENCODE.bing_ren.e10_5.forebrain.h3k27ac_dense", "global.percentile")            
    
    gvtrack.create("es_k4me3", "Encode.esb4.h3k4me3.rep1", "global.percentile")
    gvtrack.create("e10_limb_k4me3", "ENCODE.bing_ren.e10_5.limb.h3k4me3_sum", "global.percentile")
    gvtrack.create("e10_heart_k4me3", "ENCODE.bing_ren.e10_5.heart.h3k4me3_sum", "global.percentile")
    gvtrack.create("e10_midbrain_k4me3", "ENCODE.bing_ren.e10_5.midbrain.h3k4me3_sum", "global.percentile")
    gvtrack.create("e10_hindbrain_k4me3", "ENCODE.bing_ren.e10_5.hindbrain.h3k4me3_sum", "global.percentile")
    gvtrack.create("e10_forebrain_k4me3", "ENCODE.bing_ren.e10_5.forebrain.h3k4me3_sum", "global.percentile")    

    gvtrack.create("e11_limb_k4me1", "ENCODE.bing_ren.e11_5.limb.h3k4me1_rep1_1", "global.percentile")
    gvtrack.create("e11_heart_k4me1", "ENCODE.bing_ren.e11_5.heart.h3k4me1_rep1", "global.percentile")
    gvtrack.create("e11_midbrain_k4me1", "ENCODE.bing_ren.e11_5.midbrain.h3k4me1_rep1", "global.percentile")
    gvtrack.create("e11_hindbrain_k4me1", "ENCODE.bing_ren.e11_5.hindbrain.h3k4me1_rep1_1", "global.percentile")
    gvtrack.create("e11_forebrain_k4me1", "ENCODE.bing_ren.e11_5.forebrain.h3k4me1_rep1_1", "global.percentile")
    gvtrack.create("e11_liver_k4me1", "ENCODE.bing_ren.e11_5.liver.h3k4me1_rep1_1", "global.percentile")    

    gvtrack.create("e11_limb_k4me3", "ENCODE.bing_ren.e11_5.limb.h3k4me3_rep1", "global.percentile")
    gvtrack.create("e11_heart_k4me3", "ENCODE.bing_ren.e11_5.heart.h3k4me3_rep1", "global.percentile")
    gvtrack.create("e11_midbrain_k4me3", "ENCODE.bing_ren.e11_5.midbrain.h3k4me3_rep1", "global.percentile")
    gvtrack.create("e11_hindbrain_k4me3", "ENCODE.bing_ren.e11_5.hindbrain.h3k4me3_rep1", "global.percentile")
    gvtrack.create("e11_forebrain_k4me3", "ENCODE.bing_ren.e11_5.forebrain.h3k4me3_rep1", "global.percentile")
    gvtrack.create("e11_liver_k4me3", "ENCODE.bing_ren.e11_5.liver.h3k4me3_rep1", "global.percentile")    

    gvtrack.create("e10_fc_k27me3", "ENCODE.bing_ren.e10_5.embryonic_facial_prominence.h3k27me3_sum", "global.percentile")
    gvtrack.create("e10_forebrain_k27me3", "ENCODE.bing_ren.e10_5.forebrain.h3k27me3_sum", "global.percentile")
    gvtrack.create("e10_heart_k27me3", "ENCODE.bing_ren.e10_5.heart.h3k27me3_sum", "global.percentile")
    gvtrack.create("e10_hindbrain_k27me3", "ENCODE.bing_ren.e10_5.hindbrain.h3k27me3_sum", "global.percentile")
    gvtrack.create("e10_limb_k27me3", "ENCODE.bing_ren.e10_5.limb.h3k27me3_sum", "global.percentile")
    gvtrack.create("e10_midbrain_k27me3", "ENCODE.bing_ren.e10_5.midbrain.h3k27me3_sum", "global.percentile")
    gvtrack.create("es_k27me3", "Encode.esb4.h3k27me3.rep1", "global.percentile")

    gvtrack.create("e11_forebrain_k27me3", "ENCODE.bing_ren.e11_5.forebrain.h3k27me3_rep1_1", "global.percentile")
    gvtrack.create("e11_heart_k27me3", "ENCODE.bing_ren.e11_5.heart.h3k27me3_rep1_1", "global.percentile")
    gvtrack.create("e11_hindbrain_k27me3", "ENCODE.bing_ren.e11_5.hindbrain.h3k27me3_rep1_1", "global.percentile")
    gvtrack.create("e11_limb_k27me3", "ENCODE.bing_ren.e11_5.limb.h3k27me3_rep1_1", "global.percentile")
    gvtrack.create("e11_midbrain_k27me3", "ENCODE.bing_ren.e11_5.midbrain.h3k27me3_rep1_1", "global.percentile")    


    gvtrack.create("ecto_k27ac", "Xiang_Nature_Genetics_2019.Ect_H3K27ac", "global.percentile")
    gvtrack.create("ecto_k27me3", "Xiang_Nature_Genetics_2019.Ect_H3K27me3", "global.percentile")
    gvtrack.create("ecto_k4me3", "Xiang_Nature_Genetics_2019.Ect_H3K4me3", "global.percentile")
    gvtrack.create("ecto_atac", "Xiang_Nature_Genetics_2019.Ect_ATAC", "global.percentile")

    gvtrack.create("endo_k27ac", "Xiang_Nature_Genetics_2019.End_H3K27ac", "global.percentile")
    gvtrack.create("endo_k27me3", "Xiang_Nature_Genetics_2019.End_H3K27me3", "global.percentile")
    gvtrack.create("endo_k4me3", "Xiang_Nature_Genetics_2019.End_H3K4me3", "global.percentile")
    gvtrack.create("endo_atac", "Xiang_Nature_Genetics_2019.End_ATAC", "global.percentile")

    gvtrack.create("meso_k27ac", "Xiang_Nature_Genetics_2019.Mes_H3K27ac", "global.percentile")
    gvtrack.create("meso_k27me3", "Xiang_Nature_Genetics_2019.Mes_H3K27me3", "global.percentile")
    gvtrack.create("meso_k4me3", "Xiang_Nature_Genetics_2019.Mes_H3K4me3", "global.percentile")
    gvtrack.create("meso_atac", "Xiang_Nature_Genetics_2019.Mes_ATAC", "global.percentile")

    gvtrack.create("ps_k27ac", "Xiang_Nature_Genetics_2019.PS_H3K27ac", "global.percentile")
    gvtrack.create("ps_k27me3", "Xiang_Nature_Genetics_2019.PS_H3K27me3", "global.percentile")
    gvtrack.create("ps_k4me3", "Xiang_Nature_Genetics_2019.PS_H3K4me3", "global.percentile")
    gvtrack.create("ps_atac", "Xiang_Nature_Genetics_2019.PS_ATAC", "global.percentile")    

    gvtrack.create("e6_epi_k27ac", "Xiang_Nature_Genetics_2019.E65Epi_H3K27ac", "global.percentile")
    gvtrack.create("e6_epi_k27me3", "Xiang_Nature_Genetics_2019.E65Epi_H3K27me3", "global.percentile")
    gvtrack.create("e6_epi_k4me3", "Xiang_Nature_Genetics_2019.E65Epi_H3K4me3", "global.percentile")

    gvtrack.create("e5_epi_k27me3", "Xiang_Nature_Genetics_2019.E55Epi_H3K27me3", "global.percentile")
    gvtrack.create("e5_epi_k4me3", "Xiang_Nature_Genetics_2019.E55Epi_H3K4me3", "global.percentile")

    gvtrack.create("e6_ve_k27ac", "Xiang_Nature_Genetics_2019.E65VE_H3K27ac", "global.percentile")
    gvtrack.create("e6_ve_k27me3", "Xiang_Nature_Genetics_2019.E65VE_H3K27me3", "global.percentile")
    gvtrack.create("e6_ve_k4me3", "Xiang_Nature_Genetics_2019.E65VE_H3K4me3", "global.percentile")
    gvtrack.create("e6_ve_atac", "Xiang_Nature_Genetics_2019.E65VE_ATAC", "global.percentile")  
    
}

define_k27me3_peaks <- function(){
    opt <- options(gmultitasking = TRUE)
    on.exit(options(opt))
    define_chip_vtracks()

    hits <- gscreen("-log2(1-ecto_k27me3)>7 | -log2(1-endo_k27me3)>7 | -log2(1-meso_k27me3)>7 | -log2(1-ps_k27me3)>7 | -log2(1-e6_epi_k27me3)>7 | -log2(1-e5_epi_k27me3)>7 | -log2(1-e6_ve_k27me3)>7 | -log2(1-e10_fc_k27me3)>7 | -log2(1-e10_forebrain_k27me3)>7 | -log2(1-e10_heart_k27me3)>7 | -log2(1-e10_hindbrain_k27me3)>7 | -log2(1-e10_limb_k27me3)>7 | -log2(1-e10_midbrain_k27me3)>7 | -log2(1-es_k27me3)>7", iterator = 20)
    return(as_tibble(hits))    
}

define_k4me3_peaks <- function(){
    opt <- options(gmultitasking = TRUE)
    on.exit(options(opt))
    define_chip_vtracks()

    hits <- gscreen("-log2(1-e10_limb_k4me3)>7 | -log2(1-e10_heart_k4me3)>7 | -log2(1-e10_midbrain_k4me3)>7 | -log2(1-e10_hindbrain_k4me3)>7 | -log2(1-e10_forebrain_k4me3)>7 | -log2(1-e11_liver_k4me3)>7 | -log2(1-ecto_k4me3)>7 | -log2(1-endo_k4me3)>7 | -log2(1-meso_k4me3)>7 | -log2(1-ps_k4me3)>7 | -log2(1-e6_epi_k4me3)>7 | -log2(1-e5_epi_k4me3)>7 | -log2(1-e6_ve_k4me3)>7")
    return(as_tibble(hits))    
}

define_atac_peaks <- function(){
    opt <- options(gmultitasking = TRUE)
    on.exit(options(opt))
    define_chip_vtracks()

    hits <- gscreen("-log2(1-ecto_atac)>7 | -log2(1-endo_atac)>7 | -log2(1-meso_atac)>7 |  -log2(1-ps_atac)>7 |  -log2(1-e6_ve_atac)>7")

    gl <- c("ecto", "endo", "meso", "ps", "e6_ve")
    tracks <- glue("-log2(1-{gl}_atac)")
    expr <- paste(glue("{tracks}>7"), collapse=" | ")

    hits <- gscreen(expr)    

    enh <- gextract(tracks, colnames=glue("{gl}_atac"), iterator=hits, intervals=hits) %>% arrange(intervalID) %>% select(-intervalID)
    return(as_tibble(enh))
}


define_enhancer_intervs <- function() {
    opt <- options(gmultitasking = TRUE)
    on.exit(options(opt))
    define_chip_vtracks()

    hits <- gscreen("-log2(1-e10_limb_k4me1)>7 | -log2(1-e11_liver_k4me1)>7 | -log2(1-e10_heart_k4me1)>7 | -log2(1-e10_midbrain_k4me1)>7 | -log2(1-e10_hindbrain_k4me1)>7 | -log2(1-e10_forebrain_k4me1)>7")
    return(as_tibble(hits))
}

define_enhancer_intervs_germ_layers <- function(gl = c("ecto", "endo", "meso", "ps")) {
    opt <- options(gmultitasking = TRUE)
    on.exit(options(opt))
    define_chip_vtracks()

    tracks <- glue("-log2(1-{gl}_k27ac)")
    expr <- paste(glue("{tracks}>7"), collapse=" | ")

    hits <- gscreen(expr)

    enh <- gextract(tracks, colnames=glue("{gl}_k27ac"), iterator=hits, intervals=hits) %>% arrange(intervalID) %>% select(-intervalID)
    return(as_tibble(enh))
}

get_all_enhancers <- function(){
    enh_intervs_gl <-  define_enhancer_intervs_germ_layers() %cache_df% here("output/enh_intervs_germ_layers.csv") %>% as_tibble()
    enh_intervs_encode <- define_enhancer_intervs() %cache_df% here("output/enh_intervs_encode.csv") %>% as_tibble()
    enh_intervs <- bind_rows(enh_intervs_gl %>% select(chrom, start, end), enh_intervs_encode %>% select(chrom, start, end)) %>% distinct(chrom, start, end)
    
    # gintervals.save(intervals = enh_intervs, intervals.set.out = "emb_putative_enhancers")
    return(enh_intervs)
}

get_all_enhancers_with_max <- function(){
    define_chip_vtracks()
    vtracks <- c(
        "e10_limb_k4me1",
        "e14_limb_k4me1",
        "e10_heart_k4me1",
        "e14_heart_k4me1",
        "e10_fc_k4me1",
        "e10_midbrain_k4me1",
        "e14_midbrain_k4me1",
        "e10_hindbrain_k4me1",
        "e14_hindbrain_k4me1",
        "e10_forebrain_k4me1",
        "e14_forebrain_k4me1",
        "e11_liver_k4me1",
        "e14_liver_k4me1",
        "e14_stomach_k4me1",
        "e14_lung_k4me1",
        "e14_intestine_k4me1",
        "e14_kidney_k4me1",
        "e6_epi_k27ac",
        "e6_VE_k27ac",
        "e7_ecto_k27ac",
        "e7_endo_k27ac",
        "e7_meso_k27ac",
        "e7_PS_k27ac",
        "e10_limb_k27ac",
        "e10_heart_k27ac",
        "e10_midbrain_k27ac",
        "e10_hindbrain_k27ac",
        "e10_forebrain_k27ac",
        "e11_limb_k4me1",
        "e11_heart_k4me1",
        "e11_midbrain_k4me1",
        "e11_hindbrain_k4me1",
        "e11_forebrain_k4me1",
        "ecto_k27ac",
        "endo_k27ac",
        "meso_k27ac",
        "ps_k27ac",
        "e6_ve_k27ac")
    
    stopifnot(all(vtracks %in% gvtrack.ls()))
    
    df <- tibble(vt = vtracks) %>% mutate(expr = glue("-log2(1-{vt})"))
    
    expr <- paste(glue("{df$expr}>7"), collapse=" | ")
    browser()
    opt <- options(gmultitasking = FALSE)
    on.exit(options(opt))
    hits <- gscreen(expr, intervals = gintervals.all())

    
    future::plan(future::multicore, workers=20)
    # furrr::future_pmap_dfr()
    pmap_dfr(df, function(vt, expr) {
        browser()
    })
    
    
    
    
}

